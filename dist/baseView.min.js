!function($,n,e,i){"use strict";$.wk=$.wk||{};var o=$.wk.getTemplate,r=$.wk.repo&&$.wk.repo.require,s=i.app&&i.app.$document||$(document),d=i.app&&i.app.$window||$(i),t=n.View.extend({constructor:function(){this.subviews={},this.modelSubviews={},n.View.apply(this,arguments)},close:function(){this.beforeClose&&this.beforeClose(),this.closeSubviews(),this.trigger("closingView"),this.ens&&(s.off(this.ens),d.off(this.ens)),this.onDocCancel.registry&&e.each(this.onDocCancel.registry,function(i,e){i&&(s.off(e),delete this.onDocCancel.registry[e])},this),this.deferreds&&e.each(this.deferreds,function(i){e.isObject(i)&&i.state&&"pending"===i.state()&&t.onCloseWithPendingDeferred(i)}),this.remove(),this.closed=!0,this.afterClose&&this.afterClose()},closeSubviews:function(i){this.hasSubviews()&&(i?(e.invoke(this["subviews-"+i],"close"),delete this["subviews-"+i]):(e.invoke(this.subviews,"close"),this.subviews={},this.modelSubviews={}))},addSubview:function(i,s){return this.subviews[i.cid]=i,i.model&&(this.modelSubviews[i.model.cid]=i),s&&(this["subviews-"+s]=this["subviews-"+s]||{},this["subviews-"+s][i.cid]=i),i.on("closingView",e.bind(function(){delete this.subviews[i.cid],i.model&&delete this.modelSubviews[i.model.cid],s&&this["subviews-"+s]&&delete this["subviews-"+s][i.cid]},this)),i},closeSubview:function(i){var e=this.modelSubviews[i.cid];return e?void e.close():!1},getSubview:function(e){return this.modelSubviews[e.cid]?this.modelSubviews[e.cid]:!1},hasSubviews:function(){return e.size(this.subviews)>0},publishEvent:function(e,i){s.trigger(e,[i])},subscribeToEvent:function(i,n,t){this.setupEventNamespace();var o=e.reduce(e.isArray(i)?i:i.split(" "),function(e,i){return e+(i+this.ens)+" "},"",this);t||(t=this),s.on(o,e.bind(n,t))},loadingOn:function(){this.$loadingHtml=this.$loadingHtml||$(t.loadingHtml).appendTo(this.$el),!$.contains(this.el,this.$loadingHtml[0])&&this.$loadingHtml.appendTo(this.$el),this.$loadingHtml.addClass("on")},loadingOff:function(){this.$loadingHtml&&this.$loadingHtml.removeClass("on")},onDocCancel:function(n,t,o,r){this.onDocCancel.registry=this.onDocCancel.registry||{},this.setupEventNamespace();var e=this.ens+n,i=this.onDocCancel.registry,d=o||this.$el;return"off"===t?(s.off(e),void(i[e]=!1)):i[e]?void 0:(s.on("click"+e+" keyup"+e,function(n){if(27===n.keyCode)t();else{var o=$(n.target);o.parents().is(d)||t()}r&&(s.off(e),i[e]=!1)}),i[e]=!0,this)},setupEventNamespace:function(){return this.ens=this.ens||".ens"+this.cid,this},getTemplate:function(n,i,s){var t=this;this.templates=this.templates||{};var e=o(i,function(e){t.templates[n]=e,s&&s.call(t,e)});return e.baseViewDeferred="template: "+i,this.deferreds=this.deferreds||[],this.deferreds.push(e),e},require:function(s,t,e){e||(e=this);var i=r(s,t,e);return i.baseViewDeferred="require: "+s,this.deferreds=this.deferreds||[],this.deferreds.push(i),i},whenDone:function(s,o,r,t){var d=this,n=$.Deferred();return t||(t=this),!e.isArray(s)&&(s=[s]),e.each(s,function(i){e.isObject(i)&&!i.baseViewDeferred&&d.deferreds.push(i)}),$.when.apply(i,s).done(function(){o&&o.apply(t,arguments),n.resolve()}).fail(function(){r&&r.apply(t,arguments),n.reject()}),n}});$.extend(t,{loadingHtml:'<div class="loader"><span class="graphics">Loading</span></div>',onCloseWithPendingDeferred:function(e){e.abort?e.abort():e.reject()}}),$.wk.baseView=t,i.app&&"undefined"==typeof i.app.baseView&&(i.app.baseView=t)}(window.jQuery,window.Backbone,window._,window);