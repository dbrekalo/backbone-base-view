!function(e,i){"function"==typeof define&&define.amd?define(["jquery","backbone","underscore"],i):"object"==typeof module&&module.exports?module.exports=i(require("jquery"),require("backbone"),require("underscore")):e.BaseView=i(e.jQuery,e.Backbone,e._)}(this,function(e,i,t){function s(e,i,n){if(t.isArray(i))return t.some(i,function(i){return s(e,i)});var h=!0,d=r.indexOf(i),u=d<0,a=d>=0&&o[d];return u?e instanceof i||(h=!1):"array"===a?!t.isArray(e)&&(h=!1):typeof e!==a&&(h=!1),h}function n(e,i){return e.replace(h,function(e,t){var s=0===t.indexOf("this."),n=s?i:window,r=(s?t.slice(5):t).split(".");for(var o in r)if(void 0===(n=n[r[o]]))throw new Error("Undefined variable in event string");return n})}var r=[String,Number,Boolean,Function,Object,Array],o=["string","number","boolean","function","object","array"],h=/{{\s*(\S+)\s*}}/g,d={window:window,document:window.document},u=i.View.extend({constructor:function(e){this.assignOptions&&(this.writeOptions.apply(this,arguments),this.optionRules&&this.validateOptions(this.options,this.optionRules)),i.View.apply(this,arguments),this.events&&this.setupEvents()},delegatedEvents:!0,parseEventVariables:!0,assignOptions:!1,writeOptions:function(i){var s={},n=[{},t.result(this,"defaults"),s,i];return this.optionRules&&t.each(this.optionRules,function(i,n){e.isPlainObject(i)&&void 0!==i.default&&(s[n]=t.result(i,"default"))}),"deep"===this.assignOptions&&n.unshift(!0),this.options=e.extend.apply(e,n),this},validateOptions:function(i,n){var r=[];return t.each(n,function(t,n){var o=i[n],h=typeof o;if(!1!==t.required||"undefined"!==h){var d=e.isPlainObject(t)?t.type:t;d&&!s(o,d)&&r.push('Invalid type for option "'+n+'" ("'+h+'").'),t.validator&&!t.validator(o)&&r.push('Validation of option "'+n+'" failed.')}}),this.handleValidateOptionsErrors(r)},handleValidateOptionsErrors:function(e){if(e.length)throw new Error(e.join(" "))},setupEvents:function(i){var s=i||this.events,r="function"==typeof s?s.call(this):s,o=this;if(r){var h=this.ens=this.ens||"."+this.cid;t.each(r,function(i,t){o.parseEventVariables&&(t=n(t,o));var s=0===t.indexOf("one:"),r=(s?t.slice(4):t).split(" "),u=r[0]+h,a=r.slice(1).join(" "),c=o.$el;d[a]?(c=o["$"+a]=o["$"+a]||e(d[a]),a=void 0):o.delegatedEvents||((o.elementsWithBoundEvents=o.elementsWithBoundEvents||[]).push(c=c.find(a)),a=void 0),c[s?"one":"on"](u,a,function(){("function"==typeof i?i:o[i]).apply(o,arguments)})})}return this},addDismissListener:function(i,t){var s=this;if(!i)throw new Error("Dismiss listener name not speficied");return t=e.extend({$el:this.$el},t),this.$document=this.$document||e(document),this.ens=this.ens||"."+this.cid,this.dismissListeners=this.dismissListeners||{},this.dismissListeners[i]||(this.dismissListeners[i]=function(n){27!==n.keyCode&&(e(n.target).is(t.$el)||e.contains(t.$el.get(0),n.target))||s[i].call(s)},this.$document.on("click"+this.ens+" keyup"+this.ens,this.dismissListeners[i])),this},removeDismissListener:function(e){if(!e)throw new Error("Name of dismiss listener to remove not specified");return this.dismissListeners&&this.dismissListeners[e]&&(this.$document.off("click keyup",this.dismissListeners[e]),delete this.dismissListeners[e]),this},removeEvents:function(){var e=this.ens;return e&&(this.$el&&this.$el.off(e),this.$document&&this.$document.off(e),this.$window&&this.$window.off(e),this.elementsWithBoundEvents&&(t.each(this.elementsWithBoundEvents,function(i){i.off(e)}),delete this.elementsWithBoundEvents),delete this.dismissListeners),this},addView:function(e,i){return this.views=this.views||{},this.views[e.cid]=e,e.model&&(this.viewsWithModel=this.viewsWithModel||{},this.viewsWithModel[e.model.cid]=e),i&&(this.viewsGroups=this.viewsGroups||{},this.viewsGroups[i]=this.viewsGroups[i]||{},this.viewsGroups[i][e.cid]=e),this.listenToOnce(e,"afterRemove detachView",function(){delete this.views[e.cid],e.model&&this.viewsWithModel&&delete this.viewsWithModel[e.model.cid],i&&this.viewsGroups&&this.viewsGroups[i]&&delete this.viewsGroups[i][e.cid]}),e},getGroupViews:function(e){return this.viewsGroups&&this.viewsGroups[e]?t.values(this.viewsGroups[e]):[]},hasView:function(e){return this.views&&Boolean(this.views[e.cid])},detachView:function(){return this.trigger("detachView"),this},attachToView:function(e,i){return this.detachView(),e.addView(this,i),this},removeViews:function(e){return e?this.viewsGroups&&this.viewsGroups[e]&&(t.invoke(this.viewsGroups[e],"remove"),delete this.viewsGroups[e]):(this.views&&t.invoke(this.views,"remove"),delete this.views,delete this.viewsWithModel,delete this.viewsGroups),this},getViewByModel:function(e){return this.viewsWithModel&&this.viewsWithModel[e.cid]},removeViewByModel:function(e){return this.viewsWithModel&&this.viewsWithModel[e.cid]&&this.viewsWithModel[e.cid].remove(),this},addDeferred:function(e){return this.deferreds=this.deferreds||[],t.indexOf(this.deferreds,e)<0&&this.deferreds.push(e),e},abortDeferreds:function(){return this.deferreds&&t.each(this.deferreds,function(e){"object"==typeof e&&e.state&&"pending"===e.state()&&(e.abort?e.abort():e.reject())}),delete this.deferreds,this},when:function(i,s,n){t.each(i=t.isArray(i)?i:[i],function(e){this.addDeferred(e)},this);var r=e.when.apply(e,i);return s&&r.done(t.bind(s,this)),n&&r.fail(t.bind(n,this)),r},remove:function(){return this.trigger("beforeRemove"),this.removeEvents().abortDeferreds().removeViews(),i.View.prototype.remove.call(this),this.trigger("afterRemove"),this},setElement:function(e){return this._setElement(e),this}});return t.extend(u.prototype,{undelegateEvents:u.prototype.removeEvents,delegateEvents:u.prototype.setupEvents}),t.each(["appendTo","prependTo","insertBefore","insertAfter"],function(e){u.prototype[e]=function(i){return this.$el[e](i instanceof u?i.$el:i),this}}),u});