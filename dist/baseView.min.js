!function(a,b,c,d){"use strict";a.wk=a.wk||{};var e=a.wk.getTemplate,f=a.wk.repo&&a.wk.repo.require,g=d.app&&d.app.$document||a(document),h=d.app&&d.app.$window||a(d),i=b.View.extend({constructor:function(){this.subviews={},this.modelSubviews={},b.View.apply(this,arguments)},close:function(){this.beforeClose&&this.beforeClose(),this.closeSubviews(),this.trigger("closingView"),this.ens&&(g.off(this.ens),h.off(this.ens)),this.onDocCancel.registry&&c.each(this.onDocCancel.registry,function(a,b){a&&(g.off(b),delete this.onDocCancel.registry[b])},this),this.deferreds&&c.each(this.deferreds,function(a){c.isObject(a)&&a.state&&"pending"===a.state()&&i.onCloseWithPendingDeferred(a)}),this.remove(),this.closed=!0,this.afterClose&&this.afterClose()},closeSubviews:function(a){this.hasSubviews()&&(a?(c.invoke(this["subviews-"+a],"close"),delete this["subviews-"+a]):(c.invoke(this.subviews,"close"),this.subviews={},this.modelSubviews={}))},addSubview:function(a,b){return this.subviews[a.cid]=a,a.model&&(this.modelSubviews[a.model.cid]=a),b&&(this["subviews-"+b]=this["subviews-"+b]||{},this["subviews-"+b][a.cid]=a),a.on("closingView",c.bind(function(){delete this.subviews[a.cid],a.model&&delete this.modelSubviews[a.model.cid],b&&this["subviews-"+b]&&delete this["subviews-"+b][a.cid]},this)),a},closeSubview:function(a){var b=this.modelSubviews[a.cid];return b?void b.close():!1},getSubview:function(a){return this.modelSubviews[a.cid]?this.modelSubviews[a.cid]:!1},hasSubviews:function(){return c.size(this.subviews)>0},publishEvent:function(a,b){g.trigger(a,[b])},subscribeToEvent:function(a,b,d){this.setupEventNamespace();var e=c.reduce(c.isArray(a)?a:a.split(" "),function(a,b){return a+(b+this.ens)+" "},"",this);d||(d=this),g.on(e,c.bind(b,d))},loadingOn:function(){this.$loadingHtml=this.$loadingHtml||a(i.loadingHtml).appendTo(this.$el),!a.contains(this.el,this.$loadingHtml[0])&&this.$loadingHtml.appendTo(this.$el),this.$loadingHtml.addClass("on")},loadingOff:function(){this.$loadingHtml&&this.$loadingHtml.removeClass("on")},onDocCancel:function(b,c,d,e){this.onDocCancel.registry=this.onDocCancel.registry||{},this.setupEventNamespace();var f=this.ens+b,h=this.onDocCancel.registry,i=d||this.$el,j=this;return"off"===c?(g.off(f),void(h[f]=!1)):h[f]?void 0:(g.on("click"+f+" keyup"+f,function(b){(27===b.keyCode||!a(b.target).is(i)&&!a.contains(i.get(0),b.target))&&(c.apply(j,arguments),e&&(g.off(f),h[f]=!1))}),h[f]=!0,this)},setupEventNamespace:function(){return this.ens=this.ens||".ens"+this.cid,this},getTemplate:function(a,b,c){var d=this;this.templates=this.templates||{};var f=e(b,function(b){d.templates[a]=b,c&&c.call(d,b)});return f.baseViewDeferred="template: "+b,this.deferreds=this.deferreds||[],this.deferreds.push(f),f},require:function(a,b,c){c||(c=this);var d=f(a,b,c);return d.baseViewDeferred="require: "+a,this.deferreds=this.deferreds||[],this.deferreds.push(d),d},whenDone:function(b,e,f,g){var h=a.Deferred();return this.deferreds=this.deferreds||[],g||(g=this),!c.isArray(b)&&(b=[b]),c.each(b,function(a){c.isObject(a)&&!a.baseViewDeferred&&this.deferreds.push(a)},this),a.when.apply(d,b).done(function(){e&&e.apply(g,arguments),h.resolve()}).fail(function(){f&&f.apply(g,arguments),h.reject()}),h},getData:function(b,c,d){return this.whenDone(a.get(b||this.url),function(a){this[c||"data"]=a,d&&d.apply(this,arguments)})}});a.extend(i,{loadingHtml:'<div class="loader"><span class="graphics">Loading</span></div>',onCloseWithPendingDeferred:function(a){a.abort?a.abort():a.reject()}}),a.wk.baseView=i,d.app&&"undefined"==typeof d.app.baseView&&(d.app.baseView=i)}(window.jQuery,window.Backbone,window._,window);