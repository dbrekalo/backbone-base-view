!function(e,o,i,s){"use strict";e.wk=e.wk||{};var r=e.wk.getTemplate,a=e.wk.repo&&e.wk.repo.require,t=s.app&&s.app.$document||e(document),d=s.app&&s.app.$window||e(s),n=o.View.extend({constructor:function(){this.subviews={},this.modelSubviews={},o.View.apply(this,arguments)},close:function(e){this.beforeClose&&this.beforeClose(),e&&!e.parentClosing&&this.trigger("manualClosing"),this.closeSubviews(),this.ens&&(t.off(this.ens),d.off(this.ens)),this.onDocCancel.registry&&i.each(this.onDocCancel.registry,function(i,e){i&&(t.off(e),delete this.onDocCancel.registry[e])},this),this.deferreds&&i.each(this.deferreds,function(e){e.state&&"pending"===e.state()&&n.onCloseWithPendingDeferred(e)}),this.remove(),this.closed=!0,this.afterClose&&this.afterClose()},closeSubviews:function(e){this.hasSubviews()&&(e?(i.invoke(this["subviews-"+e],"close"),delete this["subviews-"+e]):(i.each(this.subviews,function(e){e.close({parentClosing:!0})}),this.subviews={},this.modelSubviews={}))},addSubview:function(e,s){return this.subviews[e.cid]=e,e.model&&(this.modelSubviews[e.model.cid]=e),s&&(this["subviews-"+s]=this["subviews-"+s]||{},this["subviews-"+s][e.cid]=e),e.on("manualClosing",i.bind(function(){delete this.subviews[e.cid],e.model&&delete this.modelSubviews[e.model.cid],s&&delete this["subviews-"+s][e.cid]},this)),e},closeSubview:function(i){var e=this.modelSubviews[i.cid];return e?void e.close():!1},getSubview:function(e){return this.modelSubviews[e.cid]?this.modelSubviews[e.cid]:!1},hasSubviews:function(){return i.size(this.subviews)>0?!0:!1},publishEvent:function(e,i){t.trigger(e,[i])},subscribeToEvent:function(e,s){this.setupEventNamespace(),t.on(e+this.ens,i.bind(s,this))},loadingOn:function(){this.$loadingHtml=this.$loadingHtml||e(n.loadingHtml).appendTo(this.$el),!e.contains(this.el,this.$loadingHtml[0])&&this.$loadingHtml.appendTo(this.$el),this.$loadingHtml.addClass("on")},loadingOff:function(){this.$loadingHtml&&this.$loadingHtml.removeClass("on")},onDocCancel:function(o,n,r,a){this.onDocCancel.registry=this.onDocCancel.registry||{},this.setupEventNamespace();var i=this.ens+o,s=this.onDocCancel.registry,d=r||this.$el;return"off"===n?(t.off(i),void(s[i]=!1)):s[i]?void 0:(t.on("click"+i+" keyup"+i,function(o){if(27===o.keyCode)n();else{var r=e(o.target);r.parents().is(d)||n()}a&&(t.off(i),s[i]=!1)}),s[i]=!0,this)},setupEventNamespace:function(){return this.ens=this.ens||".view"+this.cid,this},getTemplate:function(n,i,s){var t=this;this.templates=this.templates||{};var e=r(i,function(e){t.templates[n]=e,s&&s.call(t,e)});return e.baseViewDeferred="template: "+i,this.deferreds=this.deferreds||[],this.deferreds.push(e),e},require:function(s,t,e){e||(e=this);var i=a(s,t,e);return i.baseViewDeferred="require: "+s,this.deferreds=this.deferreds||[],this.deferreds.push(i),i},whenDone:function(n,a,d,t){var o=this,r=e.Deferred();return!i.isArray(n)&&(n=[n]),i.each(n,function(e){!e.baseViewDeferred&&o.deferreds.push(e)}),e.when.apply(s,n).done(function(){t||(t=o),a&&a.call(t),r.resolve()}).fail(function(){t||(t=o),d&&d.call(t),r.reject()}),r}});e.extend(n,{loadingHtml:'<div class="loader"><span class="graphics">Loading</span></div>',onCloseWithPendingDeferred:function(e){e.abort?e.abort():e.reject()}}),e.wk.baseView=n,s.app&&"undefined"==typeof s.app.baseView&&(s.app.baseView=n)}(window.jQuery,window.Backbone,window._,window);